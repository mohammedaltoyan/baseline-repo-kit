name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "GitHub environment to deploy to (recommended: staging|production)"
        required: true
        default: staging
      ref:
        description: "Git ref to deploy (optional; defaults to the workflow commit SHA)"
        required: false
        default: ""
      component:
        description: "Deployment component (application|docs|api-ingress)"
        required: false
        default: application
      promotion_source:
        description: "Promotion source marker (direct|approved-flow)"
        required: false
        default: direct

permissions:
  contents: read

jobs:
  deploy:
    if: ${{ vars.DEPLOY_ENABLED == '1' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Enforce deploy policy guards
        env:
          STAGING_DEPLOY_GUARD: ${{ vars.STAGING_DEPLOY_GUARD }}
          PRODUCTION_DEPLOY_GUARD: ${{ vars.PRODUCTION_DEPLOY_GUARD }}
          DOCS_PUBLISH_GUARD: ${{ vars.DOCS_PUBLISH_GUARD }}
          API_INGRESS_DEPLOY_GUARD: ${{ vars.API_INGRESS_DEPLOY_GUARD }}
          PRODUCTION_PROMOTION_REQUIRED: ${{ vars.PRODUCTION_PROMOTION_REQUIRED }}
        run: |
          node scripts/ops/deploy-guard.js \
            --environment "${{ inputs.environment }}" \
            --component "${{ inputs.component || 'application' }}" \
            --promotion-source "${{ inputs.promotion_source || 'direct' }}"

      - name: Deploy (hook)
        shell: bash
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          DEPLOY_COMPONENT: ${{ inputs.component || 'application' }}
          DEPLOY_PROMOTION_SOURCE: ${{ inputs.promotion_source || 'direct' }}
        run: |
          set -euo pipefail

          if [ -f "scripts/deploy/deploy.sh" ]; then
            bash scripts/deploy/deploy.sh
            exit 0
          fi

          echo "Missing scripts/deploy/deploy.sh."
          echo "Implement a project-specific deploy hook and re-run this workflow."
          exit 1
