{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://baseline-kit.local/schema/baseline-config.schema.json",
  "title": "Baseline Engine Configuration",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "platform",
    "policy",
    "branching",
    "ci",
    "deployments",
    "planning",
    "security",
    "updates",
    "modules"
  ],
  "properties": {
    "version": {
      "type": "integer",
      "minimum": 1,
      "default": 1
    },
    "platform": {
      "type": "object",
      "additionalProperties": false,
      "required": ["provider"],
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["github"],
          "default": "github"
        }
      }
    },
    "policy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["profile", "require_github_app"],
      "properties": {
        "profile": {
          "type": "string",
          "enum": ["strict", "moderate", "advisory"],
          "default": "strict"
        },
        "require_github_app": {
          "type": "boolean",
          "default": false
        },
        "enforce_codeowners_protected_paths": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "branching": {
      "type": "object",
      "additionalProperties": false,
      "required": ["topology", "branches", "review_thresholds"],
      "properties": {
        "topology": {
          "type": "string",
          "enum": ["two_branch", "three_branch", "trunk", "custom"],
          "default": "two_branch"
        },
        "branches": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/branchDefinition"
          }
        },
        "review_thresholds": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "maintainers_le_1",
            "maintainers_2_to_5",
            "maintainers_ge_6"
          ],
          "properties": {
            "maintainers_le_1": {
              "$ref": "#/definitions/reviewThreshold"
            },
            "maintainers_2_to_5": {
              "$ref": "#/definitions/reviewThreshold"
            },
            "maintainers_ge_6": {
              "$ref": "#/definitions/reviewThreshold"
            }
          }
        }
      }
    },
    "ci": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "action_refs", "change_profiles", "full_lane_triggers"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["two_lane", "full", "lightweight"],
          "default": "two_lane"
        },
        "action_refs": {
          "$ref": "#/definitions/actionRefsDefinition"
        },
        "change_profiles": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/changeProfile"
          }
        },
        "full_lane_triggers": {
          "type": "object",
          "additionalProperties": false,
          "required": ["merge_queue", "manual_dispatch", "label", "paths"],
          "properties": {
            "merge_queue": { "type": "boolean", "default": true },
            "manual_dispatch": { "type": "boolean", "default": true },
            "label": { "type": "string", "default": "ci:full" },
            "paths": {
              "type": "array",
              "items": { "type": "string" },
              "default": [".github/workflows/", "scripts/ops/", "config/policy/"]
            }
          }
        }
      }
    },
    "deployments": {
      "type": "object",
      "additionalProperties": false,
      "required": ["environments", "components", "approval_matrix", "oidc"],
      "properties": {
        "environments": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/environmentDefinition"
          }
        },
        "components": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/componentDefinition"
          }
        },
        "approval_matrix": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/approvalRule"
          }
        },
        "oidc": {
          "$ref": "#/definitions/oidcDefinition"
        }
      }
    },
    "planning": {
      "type": "object",
      "additionalProperties": false,
      "required": ["required", "automation_allowlist"],
      "properties": {
        "required": {
          "type": "boolean",
          "default": true
        },
        "automation_allowlist": {
          "type": "array",
          "items": { "$ref": "#/definitions/automationAllowlistRule" },
          "default": []
        }
      }
    },
    "security": {
      "type": "object",
      "additionalProperties": false,
      "required": ["codeql", "dependency_review", "require_pinned_action_refs"],
      "properties": {
        "codeql": { "type": "boolean", "default": true },
        "dependency_review": { "type": "boolean", "default": true },
        "secret_scanning": { "type": "boolean", "default": true },
        "require_pinned_action_refs": { "type": "boolean", "default": false }
      }
    },
    "updates": {
      "type": "object",
      "additionalProperties": false,
      "required": ["channel", "apply_mode", "auto_pr"],
      "properties": {
        "channel": {
          "type": "string",
          "enum": ["stable", "next"],
          "default": "stable"
        },
        "apply_mode": {
          "type": "string",
          "enum": ["pr_first", "direct"],
          "default": "pr_first"
        },
        "auto_pr": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "modules": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": ["core-governance", "core-ci", "core-deployments", "core-planning"]
        }
      }
    }
  },
  "definitions": {
    "branchDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "role", "protected", "allowed_sources"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "role": {
          "type": "string",
          "enum": ["integration", "production", "hotfix", "release", "feature", "custom"]
        },
        "protected": { "type": "boolean" },
        "allowed_sources": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "reviewThreshold": {
      "type": "object",
      "additionalProperties": false,
      "required": ["required_non_author_approvals", "require_strict_ci", "require_codeowners"],
      "properties": {
        "required_non_author_approvals": {
          "type": "integer",
          "minimum": 0
        },
        "require_strict_ci": {
          "type": "boolean"
        },
        "require_codeowners": {
          "type": "boolean"
        }
      }
    },
    "changeProfile": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "description", "include_re", "skip_full_lane"],
      "properties": {
        "id": { "type": "string" },
        "description": { "type": "string" },
        "include_re": {
          "type": "array",
          "items": { "type": "string" }
        },
        "exclude_re": {
          "type": "array",
          "items": { "type": "string" }
        },
        "skip_full_lane": {
          "type": "boolean"
        },
        "run_fast_checks": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "actionRefsDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["checkout", "setup_node"],
      "properties": {
        "checkout": { "type": "string", "minLength": 1, "default": "actions/checkout@v6" },
        "setup_node": { "type": "string", "minLength": 1, "default": "actions/setup-node@v6" }
      }
    },
    "environmentDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "branch_roles", "default"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "branch_roles": {
          "type": "array",
          "items": { "type": "string" }
        },
        "default": {
          "type": "boolean"
        }
      }
    },
    "componentDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "path", "enabled"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "minLength": 1 },
        "path": { "type": "string", "minLength": 1 },
        "enabled": { "type": "boolean" }
      }
    },
    "oidcDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled", "audience"],
      "properties": {
        "enabled": { "type": "boolean", "default": false },
        "audience": { "type": "string", "default": "" }
      }
    },
    "approvalRule": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "environment",
        "component",
        "approval_required",
        "min_approvers",
        "allow_self_approval",
        "allowed_roles"
      ],
      "properties": {
        "environment": { "type": "string" },
        "component": { "type": "string" },
        "approval_required": { "type": "boolean" },
        "min_approvers": { "type": "integer", "minimum": 0 },
        "allow_self_approval": { "type": "boolean" },
        "allowed_roles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "automationAllowlistRule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "head_ref_prefix", "base_ref", "allowed_paths"],
      "properties": {
        "id": { "type": "string" },
        "head_ref_prefix": { "type": "string" },
        "base_ref": { "type": "string" },
        "allowed_paths": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  }
}
